<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-E0H9DY9T0F"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-E0H9DY9T0F');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>My Page - Liberty and Innovation</title>
    <meta name="description" content="ììœ ì™€í˜ì‹  íšŒì› ë§ˆì´í˜ì´ì§€ì…ë‹ˆë‹¤.">
    
    <!-- íŒŒë¹„ì½˜ -->
    <link rel="icon" type="image/png" href="../images/favicon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#A50034',
                        'primary-dark': '#8B002C',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css">
    <link rel="stylesheet" href="../style.css">
    <script src="config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>
    
    <style>
        .section-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .info-row {
            display: flex;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            width: 100px;
            color: #6b7280;
            font-size: 0.875rem;
            flex-shrink: 0;
        }
        .info-value {
            flex: 1;
            color: #1f2937;
        }
        .form-input {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }
        .form-input:focus {
            outline: none;
            border-color: #A50034;
            box-shadow: 0 0 0 2px rgba(165, 0, 52, 0.1);
        }
        .btn-primary {
            background: #A50034;
            color: white;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background: #8B002C;
        }
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-primary {
            background: #fef2f2;
            color: #A50034;
        }
        .badge-success {
            background: #ecfdf5;
            color: #059669;
        }
        .badge-gray {
            background: #f3f4f6;
            color: #6b7280;
        }
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
    <script src="../analytics.js"></script>
</head>
<body class="bg-gray-100">
    <div id="navigation-container"></div>
    
    <main class="min-h-screen pt-24 pb-16">
        <div class="max-w-3xl mx-auto px-4">
            <!-- ë¡œë”© -->
            <div id="loading" class="text-center py-12">
                <i class="fas fa-spinner fa-spin text-3xl text-gray-400"></i>
                <p class="text-gray-500 mt-2">ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
            
            <!-- ì»¨í…ì¸  -->
            <div id="content" class="hidden">
                <!-- í”„ë¡œí•„ ìš”ì•½ -->
                <div class="section-card bg-gradient-to-r from-primary to-red-700 text-white">
                    <div class="flex items-center gap-4">
                        <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ (í´ë¦­í•˜ë©´ ëª¨ë‹¬ ì—´ê¸°) -->
                        <div class="relative group cursor-pointer" onclick="openProfileImageModal()">
                            <div id="profileImageContainer" class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center overflow-hidden">
                                <i id="profileImageIcon" class="fas fa-user text-2xl"></i>
                                <img id="profileImagePreview" src="" alt="í”„ë¡œí•„" class="w-full h-full object-cover hidden">
                            </div>
                            <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="fas fa-camera text-white"></i>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <span id="profileNickname" class="text-xl font-bold"></span>
                                <span id="memberTypeBadge" class="badge"></span>
                            </div>
                            <p id="profileUserId" class="text-white/70 text-sm"></p>
                        </div>
                    </div>
                </div>
                
                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="section-card">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="section-title"><i class="fas fa-user text-primary"></i> ê¸°ë³¸ ì •ë³´</h2>
                        <button onclick="openEditModal()" class="text-primary text-sm hover:underline">
                            <i class="fas fa-edit mr-1"></i> ìˆ˜ì •
                        </button>
                    </div>
                    <div>
                        <div class="info-row">
                            <span class="info-label">ì•„ì´ë””</span>
                            <span id="infoUserId" class="info-value"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ë‹‰ë„¤ì„</span>
                            <span class="info-value">
                                <span id="infoNickname"></span>
                                <button onclick="openNicknameModal()" class="ml-2 text-xs text-primary hover:underline">ë³€ê²½</button>
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ì´ë¦„</span>
                            <span id="infoName" class="info-value"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ì´ë©”ì¼</span>
                            <span id="infoEmail" class="info-value"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ì—°ë½ì²˜</span>
                            <span id="infoPhone" class="info-value"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ë„ë¡œëª… ì£¼ì†Œ</span>
                            <span id="infoAddress" class="info-value"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">í–‰ì •ë™ ì£¼ì†Œ</span>
                            <span id="infoAddressDong" class="info-value"></span>
                        </div>
                    </div>
                </div>
                
                <!-- ë‹¹ì› ì •ë³´ -->
                <div class="section-card">
                    <h2 class="section-title"><i class="fas fa-id-card text-primary"></i> ë‹¹ì› ì •ë³´</h2>
                    <div id="partyMemberInfo">
                        <!-- ì¼ë°˜íšŒì›ì¸ ê²½ìš° -->
                        <div id="generalMemberSection" class="hidden">
                            <div class="bg-gray-50 rounded-lg p-4 text-center">
                                <p class="text-gray-600 mb-3">ì•„ì§ í˜ì‹  ë‹¹ì›ì´ ì•„ë‹ˆì‹­ë‹ˆë‹¤</p>
                                <a href="support.html" class="btn-primary inline-block">
                                    <i class="fas fa-user-plus mr-1"></i> ë‹¹ì› ê°€ì…í•˜ê¸°
                                </a>
                            </div>
                        </div>
                        
                        <!-- í˜ì‹ ë‹¹ì›ì¸ ê²½ìš° -->
                        <div id="partyMemberSection" class="hidden">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                <div class="flex items-center gap-2 text-green-700 font-semibold mb-2">
                                    <i class="fas fa-check-circle"></i>
                                    <span>í˜ì‹  ë‹¹ì› (ë‹¹ë¹„ ë‚©ë¶€ ì¤‘)</span>
                                </div>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div>
                                        <span class="text-gray-500">ë‚©ë¶€ ì‹œì‘ì¼</span>
                                        <p id="partyFeeStartDate" class="font-medium text-gray-900">-</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">ì›” ë‚©ë¶€ì•¡</span>
                                        <p id="partyFeeMonthly" class="font-medium text-gray-900">-</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">ì´ ë‚©ë¶€ ê¸ˆì•¡</span>
                                        <p id="partyFeeTotalPaid" class="font-medium text-gray-900">-</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">ìµœê·¼ ë‚©ë¶€ì¼</span>
                                        <p id="partyFeeLastPayment" class="font-medium text-gray-900">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- í›„ì›/êµ¬ë§¤ ë‚´ì—­ -->
                <div class="section-card">
                    <h2 class="section-title"><i class="fas fa-heart text-primary"></i> í›„ì›/êµ¬ë§¤ ë‚´ì—­</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <p class="text-gray-500 text-sm">ì´ í›„ì›ê¸ˆ</p>
                            <p id="donationTotal" class="text-xl font-bold text-gray-900">0ì›</p>
                            <p id="donationCount" class="text-xs text-gray-400">0íšŒ</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <p class="text-gray-500 text-sm">ì´ êµ¬ë§¤ê¸ˆ</p>
                            <p id="purchaseTotal" class="text-xl font-bold text-gray-900">0ì›</p>
                            <p id="purchaseCount" class="text-xs text-gray-400">0íšŒ</p>
                        </div>
                    </div>
                </div>
                
                <!-- ê³„ì • ê´€ë¦¬ -->
                <div class="section-card">
                    <h2 class="section-title"><i class="fas fa-cog text-primary"></i> ê³„ì • ê´€ë¦¬</h2>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="openPasswordModal()" class="btn-secondary">
                            <i class="fas fa-key mr-1"></i> ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                        </button>
                        <button onclick="openWithdrawModal()" class="text-red-500 hover:text-red-600 text-sm px-4 py-2">
                            <i class="fas fa-user-times mr-1"></i> íšŒì› íƒˆí‡´
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ëª¨ë‹¬ -->
    <div id="profileImageModal" class="modal">
        <div class="modal-content" style="max-width: 650px;">
            <div class="p-6">
                <h3 class="text-lg font-bold mb-4">í”„ë¡œí•„ ì´ë¯¸ì§€ ë³€ê²½</h3>
                
                <!-- Step 1: íŒŒì¼ ì„ íƒ -->
                <div id="uploadStep1">
                    <div class="flex gap-6">
                        <!-- ì™¼ìª½: ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                        <div class="flex-shrink-0">
                            <div id="modalImagePreview" class="w-32 h-32 bg-gray-100 rounded-full flex items-center justify-center overflow-hidden border-2 border-gray-200">
                                <i id="modalImageIcon" class="fas fa-user text-4xl text-gray-400"></i>
                                <img id="modalImageImg" src="" alt="ë¯¸ë¦¬ë³´ê¸°" class="w-full h-full object-cover hidden">
                            </div>
                            <p class="text-center text-xs text-gray-500 mt-2">í˜„ì¬ ì´ë¯¸ì§€</p>
                        </div>
                        
                        <!-- ì˜¤ë¥¸ìª½: ì—…ë¡œë“œ ì˜ì—­ -->
                        <div class="flex-1">
                            <!-- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ -->
                            <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-primary hover:bg-primary/5 transition-colors cursor-pointer"
                                 onclick="document.getElementById('profileImageInput').click()"
                                 ondrop="handleDrop(event)" 
                                 ondragover="handleDragOver(event)" 
                                 ondragleave="handleDragLeave(event)">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600 mb-1">ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜</p>
                                <p class="text-sm text-primary font-medium">í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                                <input type="file" id="profileImageInput" accept="image/*" class="hidden" onchange="handleFileSelect(this)">
                            </div>
                            
                            <!-- ì•ˆë‚´ ì‚¬í•­ -->
                            <div class="mt-4 text-xs text-gray-500 space-y-1">
                                <p><i class="fas fa-check text-green-500 mr-1"></i> ì§€ì› í˜•ì‹: JPG, PNG, GIF, WebP</p>
                                <p><i class="fas fa-check text-green-500 mr-1"></i> ìµœëŒ€ í¬ê¸°: 30MB (ìë™ ì••ì¶•)</p>
                                <p><i class="fas fa-info-circle text-blue-500 mr-1"></i> ì›í•˜ëŠ” ì˜ì—­ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="closeModal('profileImageModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button>
                    </div>
                </div>
                
                <!-- Step 2: í¬ë¡­ -->
                <div id="uploadStep2" class="hidden">
                    <div class="flex gap-6">
                        <!-- ì™¼ìª½: í¬ë¡­ ì˜ì—­ -->
                        <div class="flex-1">
                            <div class="bg-gray-900 rounded-lg overflow-hidden" style="max-height: 400px;">
                                <img id="cropImage" src="" alt="í¬ë¡­í•  ì´ë¯¸ì§€" style="max-width: 100%; display: block;">
                            </div>
                        </div>
                        
                        <!-- ì˜¤ë¥¸ìª½: ë¯¸ë¦¬ë³´ê¸° -->
                        <div class="flex-shrink-0 flex flex-col items-center">
                            <p class="text-xs text-gray-500 mb-2">ë¯¸ë¦¬ë³´ê¸°</p>
                            <div class="w-32 h-32 rounded-full overflow-hidden border-2 border-gray-200 bg-gray-100">
                                <div id="cropPreview" style="width: 128px; height: 128px; overflow: hidden;"></div>
                            </div>
                            
                            <!-- ì¤Œ ì»¨íŠ¸ë¡¤ -->
                            <div class="mt-4 flex items-center gap-2">
                                <button type="button" onclick="zoomOut()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center">
                                    <i class="fas fa-minus text-sm"></i>
                                </button>
                                <span class="text-xs text-gray-500">í™•ëŒ€/ì¶•ì†Œ</span>
                                <button type="button" onclick="zoomIn()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center">
                                    <i class="fas fa-plus text-sm"></i>
                                </button>
                            </div>
                            
                            <!-- íšŒì „ ì»¨íŠ¸ë¡¤ -->
                            <div class="mt-2 flex items-center gap-2">
                                <button type="button" onclick="rotateLeft()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center">
                                    <i class="fas fa-undo text-sm"></i>
                                </button>
                                <span class="text-xs text-gray-500">íšŒì „</span>
                                <button type="button" onclick="rotateRight()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center">
                                    <i class="fas fa-redo text-sm"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì—…ë¡œë“œ ì§„í–‰ ìƒíƒœ -->
                    <div id="uploadProgress" class="hidden mt-4">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-spinner fa-spin text-primary"></i>
                            <span class="text-sm text-gray-600">ì—…ë¡œë“œ ì¤‘...</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="backToStep1()" class="flex-1 btn-secondary">
                            <i class="fas fa-arrow-left mr-1"></i> ë’¤ë¡œ
                        </button>
                        <button type="button" id="uploadConfirmBtn" onclick="confirmUpload()" class="flex-1 btn-primary">
                            <i class="fas fa-upload mr-1"></i> ë³€ê²½í•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì£¼ì†Œê²€ìƒ‰ ëª¨ë‹¬ -->
    <div id="addressModal" class="modal" style="z-index: 1100;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold">ì£¼ì†Œ ê²€ìƒ‰</h3>
                    <button type="button" onclick="closeAddressModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="addressSearchWrap" style="width: 100%; height: 400px;"></div>
            </div>
        </div>
    </div>

    <!-- ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <h3 class="text-lg font-bold mb-4">ê¸°ë³¸ ì •ë³´ ìˆ˜ì •</h3>
                <form id="editForm" onsubmit="saveInfo(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„ <span class="text-xs text-gray-400">(ë³€ê²½ ë¶ˆê°€)</span></label>
                            <input type="text" id="editName" class="form-input bg-gray-100 text-gray-500 cursor-not-allowed" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë©”ì¼ <span class="text-xs text-gray-400">(ë³„ë„ ì¸ì¦ í•„ìš”)</span></label>
                            <div class="flex gap-2">
                                <input type="email" id="editEmail" class="form-input flex-1 bg-gray-100 text-gray-500 cursor-not-allowed" readonly>
                                <button type="button" onclick="openEmailChangeModal()" class="btn-secondary text-sm whitespace-nowrap">ë³€ê²½</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ì—°ë½ì²˜</label>
                            <input type="tel" id="editPhone" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ì£¼ì†Œ</label>
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="editZipCode" class="form-input w-28" placeholder="ìš°í¸ë²ˆí˜¸" readonly>
                                <button type="button" onclick="searchAddress()" class="btn-secondary text-sm">ì£¼ì†Œê²€ìƒ‰</button>
                            </div>
                            <input type="text" id="editAddress" class="form-input mb-2" placeholder="ê¸°ë³¸ì£¼ì†Œ" readonly>
                            <input type="hidden" id="editAddressDong">
                            <input type="text" id="editAddressDetail" class="form-input" placeholder="ìƒì„¸ì£¼ì†Œ">
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="closeModal('editModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button>
                        <button type="submit" class="flex-1 btn-primary">ì €ì¥</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ë‹‰ë„¤ì„ ë³€ê²½ ëª¨ë‹¬ -->
    <div id="nicknameModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <h3 class="text-lg font-bold mb-4">ë‹‰ë„¤ì„ ë³€ê²½</h3>
                <div id="nicknameStatus" class="mb-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-700"></div>
                <form id="nicknameForm" onsubmit="changeNickname(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ìƒˆ ë‹‰ë„¤ì„</label>
                        <div class="flex gap-2">
                            <input type="text" id="newNickname" class="form-input flex-1" placeholder="2~20ì" required>
                            <button type="button" onclick="checkNewNickname()" class="btn-secondary text-sm whitespace-nowrap">ì¤‘ë³µí™•ì¸</button>
                        </div>
                        <p id="nicknameError" class="text-red-500 text-sm mt-1 hidden"></p>
                        <p id="nicknameSuccess" class="text-green-500 text-sm mt-1 hidden"></p>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" onclick="closeModal('nicknameModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button>
                        <button type="submit" id="nicknameSubmitBtn" class="flex-1 btn-primary" disabled>ë³€ê²½</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ì´ë©”ì¼ ë³€ê²½ ëª¨ë‹¬ -->
    <div id="emailChangeModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <h3 class="text-lg font-bold mb-4">ì´ë©”ì¼ ë³€ê²½</h3>
                
                <!-- Step 1: ìƒˆ ì´ë©”ì¼ ì…ë ¥ -->
                <div id="emailStep1">
                    <p class="text-sm text-gray-600 mb-4">ìƒˆ ì´ë©”ì¼ ì£¼ì†Œë¡œ ì¸ì¦ ì½”ë“œê°€ ë°œì†¡ë©ë‹ˆë‹¤.</p>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">í˜„ì¬ ì´ë©”ì¼</label>
                        <input type="email" id="currentEmailDisplay" class="form-input bg-gray-100 text-gray-500" readonly>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ìƒˆ ì´ë©”ì¼</label>
                        <input type="email" id="newEmailInput" class="form-input" placeholder="ìƒˆ ì´ë©”ì¼ ì£¼ì†Œ ì…ë ¥" required>
                        <p id="emailRequestError" class="text-red-500 text-sm mt-1 hidden"></p>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" onclick="closeModal('emailChangeModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button>
                        <button type="button" onclick="requestEmailCode()" id="emailRequestBtn" class="flex-1 btn-primary">ì¸ì¦ ì½”ë“œ ë°œì†¡</button>
                    </div>
                </div>
                
                <!-- Step 2: ì¸ì¦ ì½”ë“œ ì…ë ¥ -->
                <div id="emailStep2" class="hidden">
                    <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                        <p class="text-sm text-blue-700">ğŸ“§ <strong id="sentEmailDisplay"></strong>ìœ¼ë¡œ ì¸ì¦ ì½”ë“œë¥¼ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.</p>
                        <p class="text-xs text-blue-600 mt-1">5ë¶„ ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì¸ì¦ ì½”ë“œ (6ìë¦¬)</label>
                        <input type="text" id="emailVerifyCode" class="form-input text-center text-2xl tracking-widest" placeholder="000000" maxlength="6" pattern="[0-9]{6}">
                        <p id="emailVerifyError" class="text-red-500 text-sm mt-1 hidden"></p>
                    </div>
                    <div class="flex gap-3 mb-3">
                        <button type="button" onclick="backToEmailStep1()" class="flex-1 btn-secondary">ë’¤ë¡œ</button>
                        <button type="button" onclick="verifyEmailCode()" id="emailVerifyBtn" class="flex-1 btn-primary">í™•ì¸</button>
                    </div>
                    <button type="button" onclick="requestEmailCode()" class="w-full text-sm text-gray-500 hover:text-primary">ì¸ì¦ ì½”ë“œ ì¬ë°œì†¡</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <h3 class="text-lg font-bold mb-4">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
                <form id="passwordForm" onsubmit="changePassword(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="currentPassword" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="newPassword" class="form-input" placeholder="8ì ì´ìƒ" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                            <input type="password" id="newPasswordConfirm" class="form-input" required>
                        </div>
                    </div>
                    <p id="passwordError" class="text-red-500 text-sm mt-2 hidden"></p>
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="closeModal('passwordModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button>
                        <button type="submit" class="flex-1 btn-primary">ë³€ê²½</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- íšŒì› íƒˆí‡´ ëª¨ë‹¬ -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <h3 class="text-lg font-bold text-red-600 mb-4">
                    <i class="fas fa-exclamation-triangle mr-2"></i>íšŒì› íƒˆí‡´
                </h3>
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4 text-sm text-red-700">
                    <p class="font-semibold mb-2">íƒˆí‡´ ì „ í™•ì¸ì‚¬í•­</p>
                    <ul class="space-y-1">
                        <li>â€¢ í˜ì‹  ë‹¹ì›ì¸ ê²½ìš° ë‹¹ë¹„ ë‚©ë¶€ê°€ ìë™ í•´ì§€ë©ë‹ˆë‹¤</li>
                        <li>â€¢ í›„ì›/êµ¬ë§¤ ë‚´ì—­ì€ ë²•ì  ë³´ê´€ ê¸°ê°„ ë™ì•ˆ ìœ ì§€ë©ë‹ˆë‹¤</li>
                        <li>â€¢ íƒˆí‡´ í›„ì—ë„ ì¬ê°€ì…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
                    </ul>
                </div>
                <form id="withdrawForm" onsubmit="withdraw(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">íƒˆí‡´ ì‚¬ìœ  (ì„ íƒ)</label>
                            <textarea id="withdrawReason" class="form-input" rows="3" placeholder="íƒˆí‡´ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                            <input type="password" id="withdrawPassword" class="form-input" placeholder="ë³¸ì¸ í™•ì¸ì„ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" required>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="closeModal('withdrawModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button>
                        <button type="submit" class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">íƒˆí‡´í•˜ê¸°</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ì¹´ì¹´ì˜¤ ì£¼ì†Œ API -->
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    
    <script src="../nav.js"></script>
    <script src="../footer.js"></script>
    <script>
        loadNavigation();
        
        let memberData = null;
        let nicknameChecked = false;
        
        // ë¡œê·¸ì¸ ì²´í¬
        const token = localStorage.getItem('memberToken');
        if (!token) {
            window.location.href = 'login.html?return=' + encodeURIComponent(window.location.pathname);
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', loadMemberInfo);
        
        // íšŒì› ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadMemberInfo() {
            try {
                const response = await fetch(`${window.API_BASE}/members/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // í† í° ë§Œë£Œ
                        localStorage.removeItem('memberToken');
                        localStorage.removeItem('memberInfo');
                        window.location.href = 'login.html';
                        return;
                    }
                    if (response.status === 403) {
                        // ê³„ì • ìƒíƒœ ë³€ê²½ë¨ (ìŠ¹ì¸ëŒ€ê¸°, ì •ì§€, íƒˆí‡´)
                        const result = await response.json();
                        localStorage.removeItem('memberToken');
                        localStorage.removeItem('memberInfo');
                        
                        // ìƒíƒœì— ë”°ë¥¸ ë©”ì‹œì§€ì™€ í•¨ê»˜ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                        const code = result.code || 'ACCOUNT_INACTIVE';
                        window.location.href = `login.html?status=${code}`;
                        return;
                    }
                    throw new Error('ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');
                }
                
                const result = await response.json();
                memberData = result.data;
                
                renderMemberInfo();
                
            } catch (error) {
                console.error('íšŒì› ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }
        
        // íšŒì› ì •ë³´ ë Œë”ë§
        function renderMemberInfo() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            
            // í”„ë¡œí•„ ìš”ì•½
            document.getElementById('profileNickname').textContent = memberData.nickname;
            document.getElementById('profileUserId').textContent = '@' + memberData.userId;
            
            // í”„ë¡œí•„ ì´ë¯¸ì§€
            if (memberData.profileImage) {
                document.getElementById('profileImageIcon').classList.add('hidden');
                document.getElementById('profileImagePreview').src = memberData.profileImage;
                document.getElementById('profileImagePreview').classList.remove('hidden');
            } else {
                document.getElementById('profileImageIcon').classList.remove('hidden');
                document.getElementById('profileImagePreview').classList.add('hidden');
            }
            
            // íšŒì› ìœ í˜• ë°°ì§€
            const badge = document.getElementById('memberTypeBadge');
            if (memberData.memberType === 'party_member') {
                badge.textContent = 'í˜ì‹  ë‹¹ì›';
                badge.className = 'badge bg-white/20 text-white';
            } else {
                badge.textContent = 'ì¼ë°˜ íšŒì›';
                badge.className = 'badge bg-white/20 text-white';
            }
            
            // ê¸°ë³¸ ì •ë³´
            document.getElementById('infoUserId').textContent = memberData.userId;
            document.getElementById('infoNickname').textContent = memberData.nickname;
            document.getElementById('infoName').textContent = memberData.name;
            document.getElementById('infoEmail').textContent = memberData.email;
            document.getElementById('infoPhone').textContent = memberData.phone;
            
            // ë„ë¡œëª… ì£¼ì†Œ
            let address = memberData.address || '-';
            if (memberData.addressDetail) address += ' ' + memberData.addressDetail;
            document.getElementById('infoAddress').textContent = address;
            
            // í–‰ì •ë™
            document.getElementById('infoAddressDong').textContent = memberData.addressDong || '-';
            
            // ë‹¹ì› ì •ë³´
            if (memberData.memberType === 'party_member' && memberData.happyNanum?.partyFee?.isActive) {
                document.getElementById('generalMemberSection').classList.add('hidden');
                document.getElementById('partyMemberSection').classList.remove('hidden');
                
                const fee = memberData.happyNanum.partyFee;
                document.getElementById('partyFeeStartDate').textContent = formatDate(fee.startDate);
                document.getElementById('partyFeeMonthly').textContent = formatMoney(fee.monthlyAmount) + 'ì›';
                document.getElementById('partyFeeTotalPaid').textContent = formatMoney(fee.totalPaid) + 'ì›';
                document.getElementById('partyFeeLastPayment').textContent = formatDate(fee.lastPaymentDate);
            } else {
                document.getElementById('generalMemberSection').classList.remove('hidden');
                document.getElementById('partyMemberSection').classList.add('hidden');
            }
            
            // í›„ì›/êµ¬ë§¤ ë‚´ì—­
            document.getElementById('donationTotal').textContent = formatMoney(memberData.donation?.totalAmount || 0) + 'ì›';
            document.getElementById('donationCount').textContent = (memberData.donation?.count || 0) + 'íšŒ';
            document.getElementById('purchaseTotal').textContent = formatMoney(memberData.purchase?.totalAmount || 0) + 'ì›';
            document.getElementById('purchaseCount').textContent = (memberData.purchase?.count || 0) + 'íšŒ';
        }
        
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return `${date.getFullYear()}ë…„ ${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
        }
        
        function formatMoney(amount) {
            return (amount || 0).toLocaleString();
        }
        
        // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // ì •ë³´ ìˆ˜ì • ëª¨ë‹¬
        function openEditModal() {
            document.getElementById('editName').value = memberData.name;
            document.getElementById('editEmail').value = memberData.email;
            document.getElementById('editPhone').value = memberData.phone;
            document.getElementById('editZipCode').value = memberData.zipCode || '';
            document.getElementById('editAddress').value = memberData.address || '';
            document.getElementById('editAddressDong').value = memberData.addressDong || '';
            document.getElementById('editAddressDetail').value = memberData.addressDetail || '';
            document.getElementById('editModal').classList.add('active');
        }
        
        // ì£¼ì†Œ ê²€ìƒ‰ ëª¨ë‹¬ ì—´ê¸°
        function searchAddress() {
            document.getElementById('addressModal').classList.add('active');
            
            // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
            const wrap = document.getElementById('addressSearchWrap');
            wrap.innerHTML = '';
            
            new daum.Postcode({
                oncomplete: function(data) {
                    document.getElementById('editZipCode').value = data.zonecode;
                    document.getElementById('editAddress').value = data.roadAddress || data.jibunAddress;
                    // í–‰ì •ë™ ì „ì²´ ì£¼ì†Œ (ì‹œ/ë„ + êµ¬/êµ° + í–‰ì •ë™)
                    const dong = data.hname || data.bname || '';
                    const fullDong = dong ? `${data.sido} ${data.sigungu} ${dong}` : '';
                    document.getElementById('editAddressDong').value = fullDong;
                    document.getElementById('editAddressDetail').focus();
                    closeAddressModal();
                },
                width: '100%',
                height: '100%'
            }).embed(wrap);
        }
        
        // ì£¼ì†Œ ê²€ìƒ‰ ëª¨ë‹¬ ë‹«ê¸°
        function closeAddressModal() {
            document.getElementById('addressModal').classList.remove('active');
        }
        
        // ì •ë³´ ì €ì¥
        async function saveInfo(event) {
            event.preventDefault();
            
            try {
                const response = await fetch(`${window.API_BASE}/members/me`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        phone: document.getElementById('editPhone').value,
                        zipCode: document.getElementById('editZipCode').value,
                        address: document.getElementById('editAddress').value,
                        addressDong: document.getElementById('editAddressDong').value,
                        addressDetail: document.getElementById('editAddressDetail').value
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('editModal');
                    showSuccessModal('ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
                    loadMemberInfo();
                } else {
                    alert(result.message || 'ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('ì •ë³´ ìˆ˜ì • ì˜¤ë¥˜:', error);
                alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }
        
        // ë‹‰ë„¤ì„ ëª¨ë‹¬
        async function openNicknameModal() {
            nicknameChecked = false;
            document.getElementById('newNickname').value = '';
            document.getElementById('nicknameError').classList.add('hidden');
            document.getElementById('nicknameSuccess').classList.add('hidden');
            document.getElementById('nicknameSubmitBtn').disabled = true;
            
            // ë‹‰ë„¤ì„ ë³€ê²½ ìƒíƒœ ì¡°íšŒ
            try {
                const response = await fetch(`${window.API_BASE}/members/me/nickname-status`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                const statusEl = document.getElementById('nicknameStatus');
                if (result.data.canChangeFree) {
                    statusEl.innerHTML = `<i class="fas fa-gift mr-1"></i> ë¬´ë£Œ ë³€ê²½ ê°€ëŠ¥ (${result.data.remainingFreeChanges}íšŒ ë‚¨ìŒ)`;
                    statusEl.className = 'mb-4 p-3 bg-green-50 rounded-lg text-sm text-green-700';
                } else {
                    statusEl.innerHTML = `<i class="fas fa-info-circle mr-1"></i> ë¬´ë£Œ ë³€ê²½ íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤`;
                    statusEl.className = 'mb-4 p-3 bg-yellow-50 rounded-lg text-sm text-yellow-700';
                }
            } catch (error) {
                console.error('ë‹‰ë„¤ì„ ìƒíƒœ ì¡°íšŒ ì˜¤ë¥˜:', error);
            }
            
            document.getElementById('nicknameModal').classList.add('active');
        }
        
        // ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸
        async function checkNewNickname() {
            const nickname = document.getElementById('newNickname').value.trim();
            const errorEl = document.getElementById('nicknameError');
            const successEl = document.getElementById('nicknameSuccess');
            
            errorEl.classList.add('hidden');
            successEl.classList.add('hidden');
            
            if (!nickname) {
                errorEl.textContent = 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”';
                errorEl.classList.remove('hidden');
                return;
            }
            
            if (nickname.length < 2 || nickname.length > 20) {
                errorEl.textContent = 'ë‹‰ë„¤ì„ì€ 2~20ìì—¬ì•¼ í•©ë‹ˆë‹¤';
                errorEl.classList.remove('hidden');
                return;
            }
            
            if (nickname === memberData.nickname) {
                errorEl.textContent = 'í˜„ì¬ ë‹‰ë„¤ì„ê³¼ ë™ì¼í•©ë‹ˆë‹¤';
                errorEl.classList.remove('hidden');
                return;
            }
            
            try {
                const response = await fetch(`${window.API_BASE}/members/check-nickname?nickname=${encodeURIComponent(nickname)}`);
                const result = await response.json();
                
                if (result.available) {
                    successEl.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤';
                    successEl.classList.remove('hidden');
                    nicknameChecked = true;
                    document.getElementById('nicknameSubmitBtn').disabled = false;
                } else {
                    errorEl.textContent = result.message;
                    errorEl.classList.remove('hidden');
                    nicknameChecked = false;
                    document.getElementById('nicknameSubmitBtn').disabled = true;
                }
            } catch (error) {
                errorEl.textContent = 'í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
                errorEl.classList.remove('hidden');
            }
        }
        
        // ë‹‰ë„¤ì„ ì…ë ¥ ì‹œ ì´ˆê¸°í™”
        document.getElementById('newNickname').addEventListener('input', function() {
            nicknameChecked = false;
            document.getElementById('nicknameSubmitBtn').disabled = true;
            document.getElementById('nicknameSuccess').classList.add('hidden');
        });
        
        // ë‹‰ë„¤ì„ ë³€ê²½
        async function changeNickname(event) {
            event.preventDefault();
            
            if (!nicknameChecked) {
                alert('ë‹‰ë„¤ì„ ì¤‘ë³µí™•ì¸ì„ í•´ì£¼ì„¸ìš”');
                return;
            }
            
            try {
                const response = await fetch(`${window.API_BASE}/members/me/nickname`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        nickname: document.getElementById('newNickname').value.trim()
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('nicknameModal');
                    showSuccessModal(result.message || 'ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
                    loadMemberInfo();
                } else {
                    alert(result.message || 'ë‹‰ë„¤ì„ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('ë‹‰ë„¤ì„ ë³€ê²½ ì˜¤ë¥˜:', error);
                alert('ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        // ===== ì´ë©”ì¼ ë³€ê²½ =====
        let mypagePendingEmail = '';

        function openEmailChangeModal() {
            // ì´ˆê¸°í™”
            document.getElementById('currentEmailDisplay').value = memberData.email;
            document.getElementById('newEmailInput').value = '';
            document.getElementById('emailVerifyCode').value = '';
            document.getElementById('emailRequestError').classList.add('hidden');
            document.getElementById('emailVerifyError').classList.add('hidden');
            document.getElementById('emailStep1').classList.remove('hidden');
            document.getElementById('emailStep2').classList.add('hidden');
            document.getElementById('emailRequestBtn').disabled = false;
            document.getElementById('emailRequestBtn').textContent = 'ì¸ì¦ ì½”ë“œ ë°œì†¡';
            mypagePendingEmail = '';
            
            document.getElementById('emailChangeModal').classList.add('active');
        }

        async function requestEmailCode() {
            const newEmail = document.getElementById('newEmailInput').value.trim();
            const errorEl = document.getElementById('emailRequestError');
            const btn = document.getElementById('emailRequestBtn');
            
            errorEl.classList.add('hidden');
            
            if (!newEmail) {
                errorEl.textContent = 'ìƒˆ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
                errorEl.classList.remove('hidden');
                return;
            }
            
            // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(newEmail)) {
                errorEl.textContent = 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤';
                errorEl.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'ë°œì†¡ ì¤‘...';

            try {
                const response = await fetch(`${window.API_BASE}/members/me/email/request`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ newEmail })
                });

                const result = await response.json();

                if (result.success) {
                    mypagePendingEmail = newEmail;
                    document.getElementById('sentEmailDisplay').textContent = newEmail;
                    document.getElementById('emailStep1').classList.add('hidden');
                    document.getElementById('emailStep2').classList.remove('hidden');
                } else {
                    errorEl.textContent = result.message || 'ì¸ì¦ ì½”ë“œ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤';
                    errorEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error('ì´ë©”ì¼ ì¸ì¦ ìš”ì²­ ì˜¤ë¥˜:', error);
                errorEl.textContent = 'ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ì¸ì¦ ì½”ë“œ ë°œì†¡';
            }
        }

        function backToEmailStep1() {
            document.getElementById('emailStep1').classList.remove('hidden');
            document.getElementById('emailStep2').classList.add('hidden');
            document.getElementById('emailVerifyCode').value = '';
            document.getElementById('emailVerifyError').classList.add('hidden');
        }

        async function verifyEmailCode() {
            const code = document.getElementById('emailVerifyCode').value.trim();
            const errorEl = document.getElementById('emailVerifyError');
            const btn = document.getElementById('emailVerifyBtn');
            
            errorEl.classList.add('hidden');
            
            if (!code || code.length !== 6) {
                errorEl.textContent = '6ìë¦¬ ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
                errorEl.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'í™•ì¸ ì¤‘...';

            try {
                const response = await fetch(`${window.API_BASE}/members/me/email/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ newEmail: mypagePendingEmail, code })
                });

                const result = await response.json();

                if (result.success) {
                    closeModal('emailChangeModal');
                    showSuccessModal('ì´ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    // ê¸°ë³¸ ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ì˜ ì´ë©”ì¼ í•„ë“œë„ ì—…ë°ì´íŠ¸
                    document.getElementById('editEmail').value = mypagePendingEmail;
                    loadMemberInfo(); // ì •ë³´ ìƒˆë¡œê³ ì¹¨
                } else {
                    errorEl.textContent = result.message || 'ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤';
                    errorEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error('ì´ë©”ì¼ ì¸ì¦ í™•ì¸ ì˜¤ë¥˜:', error);
                errorEl.textContent = 'í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'í™•ì¸';
            }
        }
        
        // ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬
        function openPasswordModal() {
            document.getElementById('passwordForm').reset();
            document.getElementById('passwordError').classList.add('hidden');
            document.getElementById('passwordModal').classList.add('active');
        }
        
        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
        async function changePassword(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const newPasswordConfirm = document.getElementById('newPasswordConfirm').value;
            const errorEl = document.getElementById('passwordError');
            
            errorEl.classList.add('hidden');
            
            if (newPassword.length < 8) {
                errorEl.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤';
                errorEl.classList.remove('hidden');
                return;
            }
            
            if (newPassword !== newPasswordConfirm) {
                errorEl.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
                errorEl.classList.remove('hidden');
                return;
            }
            
            try {
                const response = await fetch(`${window.API_BASE}/members/me/password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword,
                        newPasswordConfirm
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('passwordModal');
                    showSuccessModal('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
                } else {
                    errorEl.textContent = result.message;
                    errorEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì˜¤ë¥˜:', error);
                errorEl.textContent = 'ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
                errorEl.classList.remove('hidden');
            }
        }
        
        // íƒˆí‡´ ëª¨ë‹¬
        function openWithdrawModal() {
            document.getElementById('withdrawForm').reset();
            document.getElementById('withdrawModal').classList.add('active');
        }
        
        // íšŒì› íƒˆí‡´
        async function withdraw(event) {
            event.preventDefault();
            
            if (!confirm('ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }
            
            try {
                const response = await fetch(`${window.API_BASE}/members/me/withdraw`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        reason: document.getElementById('withdrawReason').value,
                        password: document.getElementById('withdrawPassword').value
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('íƒˆí‡´ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nê·¸ë™ì•ˆ ììœ ì™€í˜ì‹ ê³¼ í•¨ê»˜í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.');
                    localStorage.removeItem('memberToken');
                    localStorage.removeItem('memberInfo');
                    window.location.href = 'index.html';
                } else {
                    alert(result.message || 'íƒˆí‡´ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('íƒˆí‡´ ì˜¤ë¥˜:', error);
                alert('íƒˆí‡´ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }
        
        // ì„ íƒëœ íŒŒì¼ ì„ì‹œ ì €ì¥
        let selectedProfileFile = null;
        let cropper = null;
        
        // í”„ë¡œí•„ ì´ë¯¸ì§€ ëª¨ë‹¬ ì—´ê¸°
        function openProfileImageModal() {
            // í˜„ì¬ í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œ
            const modalIcon = document.getElementById('modalImageIcon');
            const modalImg = document.getElementById('modalImageImg');
            
            if (memberData.profileImage) {
                modalIcon.classList.add('hidden');
                modalImg.src = memberData.profileImage;
                modalImg.classList.remove('hidden');
            } else {
                modalIcon.classList.remove('hidden');
                modalImg.classList.add('hidden');
            }
            
            // ì´ˆê¸°í™” - Step 1 ë³´ì´ê¸°
            document.getElementById('uploadStep1').classList.remove('hidden');
            document.getElementById('uploadStep2').classList.add('hidden');
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('profileImageInput').value = '';
            
            // ê¸°ì¡´ Cropper ì •ë¦¬
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            
            document.getElementById('profileImageModal').classList.add('active');
        }
        
        // ë“œë˜ê·¸ ì˜¤ë²„
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.add('border-primary', 'bg-primary/10');
        }
        
        // ë“œë˜ê·¸ ë– ë‚¨
        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.remove('border-primary', 'bg-primary/10');
        }
        
        // ë“œë¡­
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.remove('border-primary', 'bg-primary/10');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }
        
        // íŒŒì¼ ì„ íƒ
        function handleFileSelect(input) {
            if (input.files.length > 0) {
                processFile(input.files[0]);
            }
        }
        
        // íŒŒì¼ ì²˜ë¦¬ â†’ Step 2ë¡œ ì´ë™
        function processFile(file) {
            // ì´ë¯¸ì§€ íŒŒì¼ ì²´í¬
            if (!file.type.startsWith('image/')) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
                return;
            }
            
            // íŒŒì¼ í¬ê¸° ì²´í¬ (30MB - ì„œë²„ì—ì„œ ì••ì¶•ë¨)
            if (file.size > 30 * 1024 * 1024) {
                alert('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 30MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
                return;
            }
            
            selectedProfileFile = file;
            
            // Step 2ë¡œ ì´ë™
            const reader = new FileReader();
            reader.onload = function(e) {
                // Step 1 ìˆ¨ê¸°ê³  Step 2 ë³´ì´ê¸°
                document.getElementById('uploadStep1').classList.add('hidden');
                document.getElementById('uploadStep2').classList.remove('hidden');
                
                // ì´ë¯¸ì§€ ë¡œë“œ
                const cropImage = document.getElementById('cropImage');
                cropImage.src = e.target.result;
                
                // ê¸°ì¡´ Cropper ì •ë¦¬
                if (cropper) {
                    cropper.destroy();
                }
                
                // Cropper ì´ˆê¸°í™”
                cropper = new Cropper(cropImage, {
                    aspectRatio: 1, // ì •ì‚¬ê°í˜•
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 0.8,
                    cropBoxResizable: true,
                    cropBoxMovable: true,
                    guides: true,
                    center: true,
                    highlight: false,
                    background: true,
                    preview: '#cropPreview',
                    responsive: true,
                    restore: false
                });
            };
            reader.readAsDataURL(file);
        }
        
        // Step 1ë¡œ ëŒì•„ê°€ê¸°
        function backToStep1() {
            document.getElementById('uploadStep1').classList.remove('hidden');
            document.getElementById('uploadStep2').classList.add('hidden');
            document.getElementById('profileImageInput').value = '';
            
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }
        
        // ì¤Œ ì¸
        function zoomIn() {
            if (cropper) cropper.zoom(0.1);
        }
        
        // ì¤Œ ì•„ì›ƒ
        function zoomOut() {
            if (cropper) cropper.zoom(-0.1);
        }
        
        // ì™¼ìª½ íšŒì „
        function rotateLeft() {
            if (cropper) cropper.rotate(-90);
        }
        
        // ì˜¤ë¥¸ìª½ íšŒì „
        function rotateRight() {
            if (cropper) cropper.rotate(90);
        }
        
        // ì—…ë¡œë“œ í™•ì¸
        async function confirmUpload() {
            if (!cropper) return;
            
            // í¬ë¡­ëœ ì´ë¯¸ì§€ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
            const canvas = cropper.getCroppedCanvas({
                width: 400,
                height: 400,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });
            
            // ì—…ë¡œë“œ ì¤‘ í‘œì‹œ
            document.getElementById('uploadProgress').classList.remove('hidden');
            document.getElementById('uploadConfirmBtn').disabled = true;
            document.getElementById('uploadConfirmBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> ì—…ë¡œë“œ ì¤‘...';
            
            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('profileImage', blob, 'profile.jpg');
                
                try {
                    const response = await fetch(`${window.API_BASE}/members/me/profile-image`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
                        const icon = document.getElementById('profileImageIcon');
                        const preview = document.getElementById('profileImagePreview');
                        
                        icon.classList.add('hidden');
                        preview.src = result.data.profileImage;
                        preview.classList.remove('hidden');
                        memberData.profileImage = result.data.profileImage;
                        
                        closeModal('profileImageModal');
                        showSuccessModal('í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    } else {
                        alert(result.message || 'ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                    }
                } catch (error) {
                    console.error('í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                    alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                } finally {
                    document.getElementById('uploadProgress').classList.add('hidden');
                    document.getElementById('uploadConfirmBtn').disabled = false;
                    document.getElementById('uploadConfirmBtn').innerHTML = '<i class="fas fa-upload mr-1"></i> ë³€ê²½í•˜ê¸°';
                }
            }, 'image/jpeg', 0.9);
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('memberToken');
                localStorage.removeItem('memberInfo');
                window.location.href = 'index.html';
            }
        }
        
        // ì„±ê³µ ëª¨ë‹¬ í‘œì‹œ
        function showSuccessModal(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').classList.add('active');
        }
        
        function closeSuccessModal() {
            document.getElementById('successModal').classList.remove('active');
        }
    </script>
    
    <!-- ì„±ê³µ ëª¨ë‹¬ -->
    <div id="successModal" class="modal">
        <div class="modal-content" style="max-width: 400px; text-align: center; padding: 30px;">
            <div style="margin-bottom: 20px;">
                <div style="width: 60px; height: 60px; background: #10b981; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-check" style="color: white; font-size: 28px;"></i>
                </div>
                <p id="successMessage" style="font-size: 16px; color: #333;"></p>
            </div>
            <button onclick="closeSuccessModal()" class="btn-primary" style="width: 100%;">í™•ì¸</button>
        </div>
    </div>
    <!-- ê³µí†µ í‘¸í„° -->
    <div id="footer-container"></div>
    <script src="../footer.js"></script>
</body>
</html>
