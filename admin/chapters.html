<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>당협 관리 - 관리자</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#A50034',
                        'primary-dark': '#8B002C',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../style.css">
    <script src="/config.js"></script>
    <style>
        .nav-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .chapter-card { transition: all 0.2s ease; cursor: grab; }
        .chapter-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .chapter-card.dragging { opacity: 0.5; cursor: grabbing; }
        .chapter-card.drag-over { border-color: #A50034 !important; background-color: #fef2f2; }
        .dong-tag { display: inline-block; background: #f3f4f6; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin: 2px; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="admin-nav-container"></div>
    <script src="admin-nav-v2.js"></script>
    <script>loadAdminNav('chapters');</script>
    
    <main class="pt-24 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">당협 관리</h1>
            <p class="text-gray-600 mt-2" id="provinceDescription">서울특별시당 지역구를 카드 형태로 관리합니다.</p>
        </div>
        
        <!-- 시도당 탭 -->
        <div class="mb-8">
            <div id="provinceTabs" class="flex flex-wrap gap-2">
                <!-- 탭 버튼들이 여기 렌더링됨 -->
            </div>
        </div>

        <!-- 통계 카드 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow p-6 flex items-center gap-4">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-map-marker-alt text-red-600 text-xl"></i>
                </div>
                <div>
                    <div class="text-sm text-gray-500">총 지역구</div>
                    <div class="text-2xl font-bold text-gray-900" id="statTotal">0</div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow p-6 flex items-center gap-4">
                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-user-check text-green-600 text-xl"></i>
                </div>
                <div>
                    <div class="text-sm text-gray-500">위원장 임명</div>
                    <div class="text-2xl font-bold text-gray-900" id="statFilled">0</div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow p-6 flex items-center gap-4">
                <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-user-times text-yellow-600 text-xl"></i>
                </div>
                <div>
                    <div class="text-sm text-gray-500">공석</div>
                    <div class="text-2xl font-bold text-gray-900" id="statVacant">0</div>
                </div>
            </div>
        </div>

        <!-- 툴바 -->
        <div class="bg-white rounded-xl shadow p-4 mb-6 flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="지역구 또는 위원장 검색..." 
                           class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <select id="filterSelect" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                    <option value="all">전체</option>
                    <option value="active">표시 중</option>
                    <option value="hidden">숨김</option>
                    <option value="filled">위원장 있음</option>
                    <option value="vacant">공석</option>
                </select>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="openAddModal()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center gap-2">
                    <i class="fas fa-plus"></i> 지역구 추가
                </button>
                <button onclick="loadChapters()" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- 지역구 카드 그리드 -->
        <div id="chaptersContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- 동적 생성 -->
        </div>

        <!-- 빈 상태 -->
        <div id="emptyState" class="hidden text-center py-20">
            <i class="fas fa-map-marked-alt text-gray-300 text-6xl mb-6"></i>
            <h3 class="text-xl font-medium text-gray-500 mb-2">지역구가 없습니다</h3>
            <p class="text-gray-400 mb-6">"지역구 추가" 버튼으로 새 지역구를 추가하세요.</p>
        </div>
    </main>

    <!-- 추가/수정 모달 -->
    <div id="chapterModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                <h2 id="modalTitle" class="text-xl font-bold text-gray-900">지역구 추가</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="chapterForm" class="p-6 space-y-6">
                <input type="hidden" id="chapterId">
                
                <!-- 기본 정보 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">지역구명 *</label>
                        <input type="text" id="chapterDistrictName" required placeholder="예: 강남"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">갑/을/병/정</label>
                        <select id="chapterDistrictSuffix"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                            <option value="">없음 (단일 지역구)</option>
                            <option value="갑">갑</option>
                            <option value="을">을</option>
                            <option value="병">병</option>
                            <option value="정">정</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">채팅방 링크</label>
                        <input type="text" id="chapterKakaoLink" placeholder="invite.kakao.com/tc/..."
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        <p class="text-xs text-gray-500 mt-1">https:// 자동 추가</p>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">행정동 (# 구분)</label>
                    <textarea id="chapterDongsRaw" rows="3" placeholder="역삼1동#역삼2동#삼성1동#삼성2동"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"></textarea>
                    <p class="text-xs text-gray-500 mt-1"># 기호로 구분하여 입력하세요</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">참고사항</label>
                    <input type="text" id="chapterNote" placeholder="예: 성동구"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                </div>
                
                <!-- 위원장 정보 -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">위원장 정보</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">성</label>
                            <input type="text" id="chairmanSurname" placeholder="홍"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">이름</label>
                            <input type="text" id="chairmanGivenName" placeholder="길동"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">웹사이트</label>
                            <input type="text" id="chairmanWebsite" placeholder="example.com"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">인스타그램</label>
                            <input type="text" id="chairmanInstagram" placeholder="instagram.com/username"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">페이스북</label>
                            <input type="text" id="chairmanFacebook" placeholder="facebook.com/username"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">스레드</label>
                            <input type="text" id="chairmanThreads" placeholder="threads.net/@username"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">X (트위터)</label>
                            <input type="text" id="chairmanX" placeholder="x.com/username"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">네이버 블로그</label>
                            <input type="text" id="chairmanNaverBlog" placeholder="blog.naver.com/username"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">유튜브</label>
                            <input type="text" id="chairmanYoutube" placeholder="youtube.com/@channel"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 pt-4 border-t">
                    <button type="button" onclick="closeModal()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                        취소
                    </button>
                    <button type="submit" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        저장
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 삭제 확인 모달 -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
            <h3 class="text-xl font-bold text-gray-900 mb-4">지역구 삭제</h3>
            <p class="text-gray-600 mb-6">정말 이 지역구를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeDeleteModal()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                    취소
                </button>
                <button onclick="confirmDelete()" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    삭제
                </button>
            </div>
        </div>
    </div>

    <!-- 토스트 메시지 -->
    <div id="toast" class="hidden fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg z-50"></div>

    <script>
        // API 기본 URL
        const API_BASE = window.API_BASE || 'https://forthefreedom-kr-production.up.railway.app/api';
        
        let chapters = [];
        let deleteTargetId = null;
        let draggedItem = null;
        let currentProvince = 'seoul';
        
        const provinces = [
            { id: 'seoul', name: '서울특별시당', hasData: true },
            { id: 'busan', name: '부산광역시당', hasData: true },
            { id: 'daegu', name: '대구광역시당', hasData: false },
            { id: 'incheon', name: '인천광역시당', hasData: false },
            { id: 'gwangju', name: '광주광역시당', hasData: false },
            { id: 'daejeon', name: '대전광역시당', hasData: false },
            { id: 'ulsan', name: '울산광역시당', hasData: false },
            { id: 'sejong', name: '세종특별자치시당', hasData: false },
            { id: 'gyeonggi', name: '경기도당', hasData: false },
            { id: 'gangwon', name: '강원특별자치도당', hasData: false },
            { id: 'chungbuk', name: '충청북도당', hasData: false },
            { id: 'chungnam', name: '충청남도당', hasData: false },
            { id: 'jeonbuk', name: '전북특별자치도당', hasData: false },
            { id: 'jeonnam', name: '전라남도당', hasData: false },
            { id: 'gyeongbuk', name: '경상북도당', hasData: false },
            { id: 'gyeongnam', name: '경상남도당', hasData: false },
            { id: 'jeju', name: '제주특별자치도당', hasData: false }
        ];
        
        // 탭 렌더링
        function renderTabs() {
            const container = document.getElementById('provinceTabs');
            container.innerHTML = provinces.map(province => {
                let btnClass = 'px-4 py-2 rounded-lg text-sm font-medium transition-all ';
                if (province.id === currentProvince) {
                    btnClass += 'bg-red-600 text-white shadow-md';
                } else if (province.hasData) {
                    btnClass += 'bg-white border-2 border-red-600 text-red-600 hover:bg-red-50';
                } else {
                    btnClass += 'bg-gray-100 text-gray-400 border border-gray-200';
                }
                return `<button class="${btnClass}" onclick="switchProvince('${province.id}')">${province.name}</button>`;
            }).join('');
        }
        
        // 시도당 변경
        function switchProvince(provinceId) {
            currentProvince = provinceId;
            const province = provinces.find(p => p.id === provinceId);
            document.getElementById('provinceDescription').textContent = 
                province.name + ' 지역구를 카드 형태로 관리합니다.';
            renderTabs();
            loadChapters();
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', () => {
            renderTabs();
            loadChapters();
            
            // 검색 & 필터
            document.getElementById('searchInput').addEventListener('input', renderChapters);
            document.getElementById('filterSelect').addEventListener('change', renderChapters);
            
            // 폼 제출
            document.getElementById('chapterForm').addEventListener('submit', handleFormSubmit);
        });

        // 지역구 목록 로드
        async function loadChapters() {
            try {
                const response = await fetch(`${API_BASE}/chapters?province=${currentProvince}&includeHidden=true`);
                const result = await response.json();
                
                if (result.success) {
                    chapters = result.data;
                    renderChapters();
                    updateStats();
                }
            } catch (error) {
                console.error('로드 오류:', error);
                showToast('데이터 로드에 실패했습니다', 'error');
            }
        }

        // 통계 업데이트
        function updateStats() {
            const total = chapters.length;
            const filled = chapters.filter(c => c.chairmanName).length;
            const vacant = total - filled;
            
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statFilled').textContent = filled;
            document.getElementById('statVacant').textContent = vacant;
        }

        // 카드 렌더링
        function renderChapters() {
            const container = document.getElementById('chaptersContainer');
            const emptyState = document.getElementById('emptyState');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filter = document.getElementById('filterSelect').value;
            
            let filtered = chapters.filter(chapter => {
                const matchesSearch = chapter.name.toLowerCase().includes(searchTerm) ||
                                     (chapter.chairmanName && chapter.chairmanName.toLowerCase().includes(searchTerm)) ||
                                     (chapter.dongsRaw && chapter.dongsRaw.toLowerCase().includes(searchTerm));
                
                const matchesFilter = filter === 'all' ||
                                     (filter === 'active' && chapter.isActive) ||
                                     (filter === 'hidden' && !chapter.isActive) ||
                                     (filter === 'filled' && chapter.chairmanName) ||
                                     (filter === 'vacant' && !chapter.chairmanName);
                
                return matchesSearch && matchesFilter;
            });
            
            if (chapters.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            container.innerHTML = filtered.map(chapter => {
                const dongs = chapter.dongs || [];
                const dongsHtml = dongs.map(d => `<span class="dong-tag">${d}</span>`).join('');
                
                return `
                <div class="chapter-card ${!chapter.isActive ? 'opacity-50' : ''} bg-white rounded-xl shadow p-6 border-2 ${!chapter.isActive ? 'border-gray-300 border-dashed' : 'border-transparent'}"
                     data-id="${chapter._id}"
                     draggable="true"
                     ondragstart="handleDragStart(event)"
                     ondragend="handleDragEnd(event)"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event)">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-bold text-gray-900">${chapter.name}</h3>
                        <div class="flex items-center gap-2">
                            <button onclick="moveChapter('${chapter._id}', 'up')" class="p-1 text-gray-400 hover:text-gray-600" title="위로">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <button onclick="moveChapter('${chapter._id}', 'down')" class="p-1 text-gray-400 hover:text-gray-600" title="아래로">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <button onclick="toggleVisibility('${chapter._id}')" class="p-1 ${chapter.isActive ? 'text-gray-400 hover:text-blue-600' : 'text-blue-600'}" title="${chapter.isActive ? '숨기기' : '표시하기'}">
                                <i class="fas ${chapter.isActive ? 'fa-eye' : 'fa-eye-slash'}"></i>
                            </button>
                            <button onclick="openDeleteModal('${chapter._id}')" class="p-1 text-gray-400 hover:text-red-600" title="삭제">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    ${chapter.note ? `<div class="text-xs text-gray-500 mb-2">${chapter.note}</div>` : ''}
                    
                    <div class="mb-4 min-h-[60px]">
                        ${dongsHtml || '<span class="text-gray-400 text-sm">행정동 정보 없음</span>'}
                    </div>
                    
                    <div class="border-t pt-4">
                        ${chapter.chairmanName ? `
                            <div class="flex items-center gap-2 flex-wrap">
                                <i class="fas fa-user-tie text-green-600"></i>
                                <span class="font-medium">${chapter.chairmanName}</span>
                                <div class="flex items-center gap-2 ml-2">
                                    ${chapter.chairmanWebsite ? `<a href="${chapter.chairmanWebsite}" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-blue-500" title="웹사이트"><i class="fas fa-globe"></i></a>` : ''}
                                    ${chapter.chairmanInstagram ? `<a href="${chapter.chairmanInstagram}" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-pink-500" title="인스타그램"><i class="fab fa-instagram"></i></a>` : ''}
                                    ${chapter.chairmanFacebook ? `<a href="${chapter.chairmanFacebook}" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-blue-600" title="페이스북"><i class="fab fa-facebook"></i></a>` : ''}
                                    ${chapter.chairmanThreads ? `<a href="${chapter.chairmanThreads}" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-gray-800" title="스레드"><i class="fas fa-at"></i></a>` : ''}
                                    ${chapter.chairmanX ? `<a href="${chapter.chairmanX}" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-gray-800" title="X(트위터)"><svg class="w-3 h-3 inline" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>` : ''}
                                    ${chapter.chairmanNaverBlog ? `<a href="${chapter.chairmanNaverBlog}" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-green-500" title="네이버 블로그"><i class="fas fa-blog"></i></a>` : ''}
                                    ${chapter.chairmanYoutube ? `<a href="${chapter.chairmanYoutube}" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-red-600" title="유튜브"><i class="fab fa-youtube"></i></a>` : ''}
                                </div>
                            </div>
                        ` : `
                            <div class="flex items-center gap-2 text-yellow-600">
                                <i class="fas fa-user-times"></i>
                                <span class="font-medium">공석</span>
                            </div>
                        `}
                    </div>
                    
                    <div class="flex items-center justify-between mt-4 pt-4 border-t text-sm">
                        <span class="text-gray-400"><i class="fas fa-grip-vertical mr-1"></i> 드래그로 순서 변경</span>
                        <button onclick="openEditModal('${chapter._id}')" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i> 수정
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }

        // 드래그 앤 드롭
        function handleDragStart(e) {
            draggedItem = e.target.closest('.chapter-card');
            draggedItem.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            if (draggedItem) draggedItem.classList.remove('dragging');
            document.querySelectorAll('.chapter-card').forEach(card => card.classList.remove('drag-over'));
        }

        function handleDragOver(e) {
            e.preventDefault();
            const card = e.target.closest('.chapter-card');
            if (card && card !== draggedItem) {
                card.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            const card = e.target.closest('.chapter-card');
            if (card) card.classList.remove('drag-over');
        }

        async function handleDrop(e) {
            e.preventDefault();
            const targetCard = e.target.closest('.chapter-card');
            if (!targetCard || targetCard === draggedItem) return;
            
            targetCard.classList.remove('drag-over');
            
            const container = document.getElementById('chaptersContainer');
            const cards = [...container.querySelectorAll('.chapter-card')];
            const fromIndex = cards.indexOf(draggedItem);
            const toIndex = cards.indexOf(targetCard);
            
            // DOM 이동
            if (fromIndex < toIndex) {
                targetCard.parentNode.insertBefore(draggedItem, targetCard.nextSibling);
            } else {
                targetCard.parentNode.insertBefore(draggedItem, targetCard);
            }
            
            // 서버에 순서 저장
            const newOrder = [...container.querySelectorAll('.chapter-card')].map(card => card.dataset.id);
            
            try {
                await fetch(`${API_BASE}/chapters/reorder`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: newOrder })
                });
                loadChapters();
            } catch (error) {
                console.error('순서 저장 오류:', error);
            }
        }

        // 위/아래 이동
        async function moveChapter(id, direction) {
            try {
                await fetch(`${API_BASE}/chapters/${id}/move`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ direction })
                });
                loadChapters();
            } catch (error) {
                console.error('이동 오류:', error);
            }
        }

        // 모달
        function openAddModal() {
            document.getElementById('modalTitle').textContent = '지역구 추가';
            document.getElementById('chapterForm').reset();
            document.getElementById('chapterId').value = '';
            document.getElementById('chapterDistrictSuffix').value = '';
            document.getElementById('chapterModal').classList.remove('hidden');
        }

        function openEditModal(id) {
            const chapter = chapters.find(c => c._id === id);
            if (!chapter) return;
            
            document.getElementById('modalTitle').textContent = '지역구 수정';
            document.getElementById('chapterId').value = id;
            
            // 지역구명과 갑/을/병/정 분리
            const nameParts = (chapter.name || '').split(' ');
            const suffix = nameParts.length > 1 && ['갑', '을', '병', '정'].includes(nameParts[nameParts.length - 1]) 
                ? nameParts.pop() : '';
            document.getElementById('chapterDistrictName').value = nameParts.join(' ');
            document.getElementById('chapterDistrictSuffix').value = suffix;
            
            document.getElementById('chapterKakaoLink').value = chapter.kakaoLink || '';
            document.getElementById('chapterDongsRaw').value = chapter.dongsRaw || '';
            document.getElementById('chapterNote').value = chapter.note || '';
            
            // 위원장 성/이름 분리 (첫 글자가 성, 나머지가 이름)
            const fullName = chapter.chairmanName || '';
            if (fullName) {
                document.getElementById('chairmanSurname').value = fullName.charAt(0);
                document.getElementById('chairmanGivenName').value = fullName.slice(1);
            } else {
                document.getElementById('chairmanSurname').value = '';
                document.getElementById('chairmanGivenName').value = '';
            }
            
            document.getElementById('chairmanWebsite').value = chapter.chairmanWebsite || '';
            document.getElementById('chairmanInstagram').value = chapter.chairmanInstagram || '';
            document.getElementById('chairmanFacebook').value = chapter.chairmanFacebook || '';
            document.getElementById('chairmanThreads').value = chapter.chairmanThreads || '';
            document.getElementById('chairmanX').value = chapter.chairmanX || '';
            document.getElementById('chairmanNaverBlog').value = chapter.chairmanNaverBlog || '';
            document.getElementById('chairmanYoutube').value = chapter.chairmanYoutube || '';
            
            document.getElementById('chapterModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('chapterModal').classList.add('hidden');
        }

        // URL 정규화 (https:// 자동 추가)
        function normalizeUrl(url) {
            if (!url || url.trim() === '') return null;
            url = url.trim();
            if (url && !url.match(/^https?:\/\//i)) {
                return 'https://' + url;
            }
            return url;
        }

        // 폼 제출
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const id = document.getElementById('chapterId').value;
            
            // 지역구명 + 갑/을/병 합치기
            const districtName = document.getElementById('chapterDistrictName').value.trim();
            const suffix = document.getElementById('chapterDistrictSuffix').value;
            const name = suffix ? `${districtName} ${suffix}` : districtName;
            
            // 성 + 이름 합치기
            const surname = document.getElementById('chairmanSurname').value.trim();
            const givenName = document.getElementById('chairmanGivenName').value.trim();
            const chairmanName = surname || givenName ? `${surname}${givenName}` : null;
            
            const data = {
                name: name,
                province: currentProvince,
                kakaoLink: normalizeUrl(document.getElementById('chapterKakaoLink').value),
                dongsRaw: document.getElementById('chapterDongsRaw').value || null,
                note: document.getElementById('chapterNote').value || null,
                chairmanName: chairmanName,
                chairmanWebsite: normalizeUrl(document.getElementById('chairmanWebsite').value),
                chairmanInstagram: normalizeUrl(document.getElementById('chairmanInstagram').value),
                chairmanFacebook: normalizeUrl(document.getElementById('chairmanFacebook').value),
                chairmanThreads: normalizeUrl(document.getElementById('chairmanThreads').value),
                chairmanX: normalizeUrl(document.getElementById('chairmanX').value),
                chairmanNaverBlog: normalizeUrl(document.getElementById('chairmanNaverBlog').value),
                chairmanYoutube: normalizeUrl(document.getElementById('chairmanYoutube').value)
            };
            
            try {
                const url = id ? `${API_BASE}/chapters/${id}` : `${API_BASE}/chapters`;
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeModal();
                    loadChapters();
                    showToast(id ? '수정되었습니다' : '추가되었습니다', 'success');
                } else {
                    const result = await response.json();
                    showToast(result.error || '저장에 실패했습니다', 'error');
                }
            } catch (error) {
                console.error('저장 오류:', error);
                showToast('저장에 실패했습니다', 'error');
            }
        }

        // 삭제
        function openDeleteModal(id) {
            deleteTargetId = id;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            deleteTargetId = null;
            document.getElementById('deleteModal').classList.add('hidden');
        }

        async function confirmDelete() {
            if (!deleteTargetId) return;
            
            try {
                const response = await fetch(`${API_BASE}/chapters/${deleteTargetId}`, { method: 'DELETE' });
                
                if (response.ok) {
                    closeDeleteModal();
                    loadChapters();
                    showToast('삭제되었습니다', 'success');
                }
            } catch (error) {
                console.error('삭제 오류:', error);
                showToast('삭제에 실패했습니다', 'error');
            }
        }

        // 숨기기/표시 토글
        async function toggleVisibility(id) {
            const chapter = chapters.find(c => c._id === id);
            if (!chapter) return;
            
            try {
                const response = await fetch(`${API_BASE}/chapters/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isActive: !chapter.isActive })
                });
                
                if (response.ok) {
                    loadChapters();
                    showToast(chapter.isActive ? '숨김 처리되었습니다' : '다시 표시됩니다', 'success');
                }
            } catch (error) {
                console.error('숨기기 오류:', error);
                showToast('처리에 실패했습니다', 'error');
            }
        }

        // 토스트 메시지
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-600 text-white' :
                type === 'error' ? 'bg-red-600 text-white' :
                'bg-gray-800 text-white'
            }`;
            toast.classList.remove('hidden');
            
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>
