<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-E0H9DY9T0F"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-E0H9DY9T0F');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프로필 - 자유와혁신</title>
    <link rel="icon" type="image/png" href="images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#A50034',
                        'primary-dark': '#8B002C',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: #f3f4f6;
        }
        .profile-container {
            max-width: 680px;
            margin: 0 auto;
        }
        
        /* 프로필 헤더 */
        .profile-header {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 16px;
        }
        .profile-cover {
            height: 150px;
            background: linear-gradient(135deg, #A50034 0%, #051C4C 100%);
        }
        .profile-info {
            padding: 0 20px 20px;
            position: relative;
        }
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid white;
            background: #f3f4f6;
            position: absolute;
            top: -50px;
            left: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .profile-avatar i {
            font-size: 2.5rem;
            color: #9ca3af;
        }
        .profile-actions {
            display: flex;
            justify-content: flex-end;
            padding-top: 12px;
            gap: 8px;
        }
        .follow-btn {
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .follow-btn.following {
            background: white;
            border: 1px solid #d1d5db;
            color: #374151;
        }
        .follow-btn.following:hover {
            border-color: #ef4444;
            color: #ef4444;
        }
        .follow-btn.not-following {
            background: #A50034;
            border: 1px solid #A50034;
            color: white;
        }
        .follow-btn.not-following:hover {
            background: #8B002C;
        }
        .profile-details {
            margin-top: 60px;
        }
        .profile-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .profile-id {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 2px;
        }
        .profile-bio {
            margin-top: 12px;
            font-size: 0.95rem;
            color: #374151;
            line-height: 1.5;
        }
        .profile-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 12px;
            font-size: 0.85rem;
            color: #6b7280;
        }
        .profile-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .profile-stats {
            display: flex;
            gap: 20px;
            margin-top: 16px;
        }
        .profile-stat {
            font-size: 0.9rem;
        }
        .profile-stat strong {
            color: #1f2937;
            font-weight: 600;
        }
        .profile-stat span {
            color: #6b7280;
        }
        
        /* 등급 배지 */
        .grade-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        .grade-general { background: #F6D219; color: #000; }
        .grade-party { background: #051C4C; color: #fff; }
        .grade-innovation { background: #A50033; color: #fff; }
        .grade-position { background: #000003; color: #fff; }
        
        /* 탭 */
        .profile-tabs {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .tabs-header {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
        }
        .tab-btn {
            flex: 1;
            padding: 16px;
            text-align: center;
            font-size: 0.95rem;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        .tab-btn:hover {
            background: #f9fafb;
        }
        .tab-btn.active {
            color: #A50034;
            border-bottom-color: #A50034;
        }
        .tab-content {
            min-height: 200px;
        }
        .tab-pane {
            display: none;
            padding: 16px;
        }
        .tab-pane.active {
            display: block;
        }
        
        /* 피드 아이템 */
        .feed-item {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        .feed-item:last-child {
            border-bottom: none;
        }
        .feed-item:hover {
            background: #fafafa;
        }
        .feed-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        .feed-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
        }
        .feed-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .feed-content {
            flex: 1;
            min-width: 0;
        }
        .feed-author {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        .feed-author-name {
            font-weight: 600;
            color: #1f2937;
        }
        .feed-author-id {
            color: #6b7280;
            font-size: 0.85rem;
        }
        .feed-date {
            color: #9ca3af;
            font-size: 0.85rem;
        }
        .feed-delete {
            margin-left: auto;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .feed-delete:hover {
            color: #ef4444;
            background: #fef2f2;
        }
        .feed-item {
            transition: opacity 0.2s, transform 0.2s;
        }
        .feed-text {
            margin-top: 6px;
            font-size: 0.95rem;
            color: #374151;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .feed-actions {
            display: flex;
            gap: 24px;
            margin-top: 12px;
        }
        .feed-action {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #6b7280;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .feed-action:hover {
            color: #A50034;
        }
        .feed-action.liked {
            color: #ef4444;
        }
        
        /* 포스트 작성 */
        .post-compose {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }
        .compose-area {
            display: flex;
            gap: 12px;
        }
        .compose-input {
            flex: 1;
        }
        .compose-input textarea {
            width: 100%;
            border: none;
            resize: none;
            font-size: 1rem;
            line-height: 1.5;
            outline: none;
            min-height: 80px;
        }
        .compose-input textarea::placeholder {
            color: #9ca3af;
        }
        .compose-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
        }
        .post-btn {
            padding: 8px 20px;
            background: #A50034;
            color: white;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
        }
        .post-btn:hover {
            background: #8B002C;
        }
        .post-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }
        
        /* 게시글 아이템 */
        .board-post-item {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        .board-post-item:hover {
            background: #fafafa;
        }
        .board-post-title {
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 6px;
        }
        .board-post-title:hover {
            color: #A50034;
        }
        .board-post-meta {
            font-size: 0.8rem;
            color: #9ca3af;
            display: flex;
            gap: 12px;
        }
        
        /* 댓글 아이템 */
        .comment-item {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        .comment-item:last-child {
            border-bottom: none;
        }
        .comment-post-link {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 6px;
        }
        .comment-post-link a {
            color: #A50034;
        }
        .comment-content {
            font-size: 0.95rem;
            color: #374151;
        }
        .comment-date {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 6px;
        }
        
        /* 빈 상태 */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }
        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }
        
        /* 로딩 */
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        /* 뒤로가기 */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: white;
            border-radius: 8px;
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .back-btn:hover {
            color: #A50034;
        }
        
        /* 삭제 확인 모달 */
        .delete-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .delete-modal.hidden {
            display: none;
        }
        .delete-modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(91, 112, 131, 0.4);
        }
        .delete-modal-content {
            position: relative;
            background: #000;
            border-radius: 16px;
            width: 320px;
            padding: 32px;
            text-align: center;
        }
        .delete-modal-content h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #e7e9ea;
            margin-bottom: 8px;
        }
        .delete-modal-content p {
            font-size: 0.9rem;
            color: #71767b;
            line-height: 1.4;
            margin-bottom: 24px;
        }
        .delete-confirm-btn {
            width: 100%;
            padding: 12px;
            background: #f4212e;
            color: white;
            border: none;
            border-radius: 9999px;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 12px;
            transition: background 0.2s;
        }
        .delete-confirm-btn:hover {
            background: #dc1e28;
        }
        .delete-cancel-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            color: #e7e9ea;
            border: 1px solid #536471;
            border-radius: 9999px;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
        }
        .delete-cancel-btn:hover {
            background: rgba(239, 243, 244, 0.1);
        }
    </style>
    <script src="/analytics.js"></script>
</head>
<body>
    <div id="navigation-container"></div>
    
    <main class="pt-20 pb-12 px-4">
        <div class="profile-container">
            <!-- 뒤로가기 -->
            <a href="javascript:history.back()" class="back-btn">
                <i class="fas fa-arrow-left"></i> 뒤로가기
            </a>
            
            <!-- 프로필 헤더 -->
            <div class="profile-header" id="profileHeader">
                <div class="profile-cover"></div>
                <div class="profile-info">
                    <div class="profile-avatar" id="profileAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="profile-actions" id="profileActions">
                        <!-- 팔로우 버튼 (로그인 시 표시) -->
                    </div>
                    <div class="profile-details">
                        <div class="profile-name">
                            <span id="profileName">로딩중...</span>
                            <span id="profileGrade" class="grade-badge"></span>
                        </div>
                        <div class="profile-id" id="profileUserId"></div>
                        <div class="profile-bio" id="profileBio"></div>
                        <div class="profile-meta">
                            <div class="profile-meta-item" id="profileJoinDate">
                                <i class="fas fa-calendar"></i>
                                <span></span>
                            </div>
                        </div>
                        <div class="profile-stats">
                            <div class="profile-stat">
                                <strong id="followingCount">0</strong>
                                <span>팔로잉</span>
                            </div>
                            <div class="profile-stat">
                                <strong id="followerCount">0</strong>
                                <span>팔로워</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 탭 -->
            <div class="profile-tabs">
                <div class="tabs-header">
                    <div class="tab-btn active" data-tab="feed" onclick="switchTab('feed')">피드</div>
                    <div class="tab-btn" data-tab="posts" onclick="switchTab('posts')">게시글</div>
                    <div class="tab-btn" data-tab="comments" onclick="switchTab('comments')">댓글</div>
                </div>
                <div class="tab-content">
                    <!-- 피드 탭 -->
                    <div class="tab-pane active" id="tab-feed">
                        <!-- 내 프로필일 때만 작성 폼 표시 -->
                        <div class="post-compose hidden" id="postCompose">
                            <div class="compose-area">
                                <div class="feed-avatar" id="myAvatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="compose-input">
                                    <textarea id="postInput" placeholder="무슨 생각을 하고 계신가요?" maxlength="500" oninput="updatePostBtn()"></textarea>
                                    <div class="compose-actions">
                                        <span style="font-size: 0.8rem; color: #9ca3af; margin-right: auto;"><span id="charCount">0</span>/500</span>
                                        <button class="post-btn" id="postBtn" disabled onclick="submitPost()">게시하기</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="feedList">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 게시글 탭 -->
                    <div class="tab-pane" id="tab-posts">
                        <div id="postsList">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 댓글 탭 -->
                    <div class="tab-pane" id="tab-comments">
                        <div id="commentsList">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- 삭제 확인 모달 -->
    <div id="deleteModal" class="delete-modal hidden">
        <div class="delete-modal-backdrop" onclick="closeDeleteModal()"></div>
        <div class="delete-modal-content">
            <h3>게시물을(를) 삭제할까요?</h3>
            <p>이 동작은 취소할 수 없으며 내 프로필, 나를 팔로우하는 계정의 타임라인, 그리고 검색 결과에서 삭제됩니다.</p>
            <button class="delete-confirm-btn" onclick="confirmDeleteFeed()">삭제하기</button>
            <button class="delete-cancel-btn" onclick="closeDeleteModal()">취소</button>
        </div>
    </div>
    
    <script src="nav.js"></script>
    <script src="footer.js"></script>
    <script>
        const API_BASE = 'https://forthefreedom-kr-production.up.railway.app/api';
        
        // URL에서 프로필 ID 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        const profileId = urlParams.get('id');
        
        let profileData = null;
        let isMyProfile = false;
        let isFollowing = false;
        let currentTab = 'feed';
        
        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            if (!profileId) {
                alert('잘못된 접근입니다');
                location.href = 'board.html';
                return;
            }
            
            loadProfile();
        });
        
        // 프로필 로드
        async function loadProfile() {
            try {
                const token = localStorage.getItem('memberToken');
                const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
                
                const response = await fetch(`${API_BASE}/members/profile/${profileId}`, { headers });
                const result = await response.json();
                
                if (result.success) {
                    profileData = result.data;
                    isMyProfile = result.data.isMyProfile;
                    isFollowing = result.data.isFollowing;
                    renderProfile();
                    loadFeed();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('프로필 로드 오류:', error);
                document.getElementById('profileName').textContent = '프로필을 찾을 수 없습니다';
            }
        }
        
        // 프로필 렌더링
        function renderProfile() {
            const { member, postCount, commentCount, followerCount, followingCount } = profileData;
            
            // 아바타
            const avatarEl = document.getElementById('profileAvatar');
            if (member.profileImage) {
                avatarEl.innerHTML = `<img src="${member.profileImage}" alt="">`;
            }
            
            // 이름 & 등급
            document.getElementById('profileName').textContent = member.nickname;
            const gradeInfo = getGradeInfo(member.memberType);
            const gradeEl = document.getElementById('profileGrade');
            gradeEl.textContent = gradeInfo.text;
            gradeEl.className = 'grade-badge ' + gradeInfo.class;
            
            // ID
            document.getElementById('profileUserId').textContent = '@' + (member.userId || member._id.slice(-8));
            
            // 자기소개
            const bioEl = document.getElementById('profileBio');
            if (member.bio) {
                bioEl.textContent = member.bio;
            } else {
                bioEl.style.display = 'none';
            }
            
            // 가입일
            const joinDate = new Date(member.createdAt);
            document.getElementById('profileJoinDate').querySelector('span').textContent = 
                `${joinDate.getFullYear()}년 ${joinDate.getMonth() + 1}월 가입`;
            
            // 팔로워/팔로잉
            document.getElementById('followerCount').textContent = followerCount || 0;
            document.getElementById('followingCount').textContent = followingCount || 0;
            
            // 버튼
            const actionsEl = document.getElementById('profileActions');
            if (isMyProfile) {
                actionsEl.innerHTML = `
                    <button class="follow-btn following" onclick="openMyPage()">
                        <i class="fas fa-cog"></i> 설정
                    </button>
                `;
                // 포스트 작성 폼 표시
                document.getElementById('postCompose').classList.remove('hidden');
                // 내 아바타 설정
                const myAvatarEl = document.getElementById('myAvatar');
                if (member.profileImage) {
                    myAvatarEl.innerHTML = `<img src="${member.profileImage}" alt="">`;
                }
            } else {
                const token = localStorage.getItem('memberToken');
                if (token) {
                    actionsEl.innerHTML = `
                        <button class="follow-btn ${isFollowing ? 'following' : 'not-following'}" id="followBtn" onclick="toggleFollow()">
                            ${isFollowing ? '팔로잉' : '팔로우'}
                        </button>
                    `;
                }
            }
            
            // 페이지 타이틀
            document.title = `${member.nickname} - 자유와혁신`;
        }
        
        // 탭 전환
        function switchTab(tab) {
            currentTab = tab;
            
            // 탭 버튼 활성화
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            
            // 탭 컨텐츠 활성화
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.toggle('active', pane.id === 'tab-' + tab);
            });
            
            // 데이터 로드
            if (tab === 'feed') {
                loadFeed();
            } else if (tab === 'posts') {
                loadPosts();
            } else if (tab === 'comments') {
                loadComments();
            }
        }
        
        // 피드 로드
        async function loadFeed() {
            const feedList = document.getElementById('feedList');
            feedList.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i></div>';
            
            try {
                const token = localStorage.getItem('memberToken');
                const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
                
                const response = await fetch(`${API_BASE}/feed/user/${profileId}`, { headers });
                const result = await response.json();
                
                if (result.success && result.data.feeds.length > 0) {
                    feedList.innerHTML = result.data.feeds.map(feed => renderFeedItem(feed)).join('');
                } else {
                    feedList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-stream"></i>
                            <p>아직 피드가 없습니다</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('피드 로드 오류:', error);
                feedList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-stream"></i>
                        <p>아직 피드가 없습니다</p>
                    </div>
                `;
            }
        }
        
        // 피드 아이템 렌더링
        function renderFeedItem(feed) {
            const date = formatDate(new Date(feed.createdAt));
            const isMyFeed = isMyProfile;
            return `
                <div class="feed-item" id="feed-${feed._id}">
                    <div class="feed-header">
                        <div class="feed-avatar">
                            ${feed.author?.profileImage 
                                ? `<img src="${feed.author.profileImage}" alt="">` 
                                : '<i class="fas fa-user"></i>'}
                        </div>
                        <div class="feed-content">
                            <div class="feed-author">
                                <span class="feed-author-name">${feed.author?.nickname || '알 수 없음'}</span>
                                <span class="feed-date">· ${date}</span>
                                ${isMyFeed ? `<span class="feed-delete" onclick="deleteFeed('${feed._id}')" title="삭제"><i class="fas fa-times"></i></span>` : ''}
                            </div>
                            <div class="feed-text">${escapeHtml(feed.content)}</div>
                            <div class="feed-actions">
                                <div class="feed-action ${feed.isLiked ? 'liked' : ''}" onclick="toggleFeedLike('${feed._id}', this)">
                                    <i class="fas fa-heart"></i>
                                    <span>${feed.likeCount || 0}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 게시글 로드
        async function loadPosts() {
            const postsList = document.getElementById('postsList');
            postsList.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i></div>';
            
            try {
                const token = localStorage.getItem('memberToken');
                const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
                
                const response = await fetch(`${API_BASE}/posts?authorId=${profileId}&limit=50`, { headers });
                const result = await response.json();
                
                if (result.success && result.data.posts.length > 0) {
                    postsList.innerHTML = result.data.posts.map(post => `
                        <div class="board-post-item" onclick="location.href='board-view.html?id=${post._id}'">
                            <div class="board-post-title">${escapeHtml(post.title)}</div>
                            <div class="board-post-meta">
                                <span><i class="fas fa-eye"></i> ${post.viewCount}</span>
                                <span><i class="fas fa-thumbs-up"></i> ${post.likeCount || 0}</span>
                                <span><i class="fas fa-comment"></i> ${post.commentCount || 0}</span>
                                <span>${formatDate(new Date(post.createdAt))}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    postsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-file-alt"></i>
                            <p>작성한 게시글이 없습니다</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('게시글 로드 오류:', error);
                postsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>게시글을 불러올 수 없습니다</p>
                    </div>
                `;
            }
        }
        
        // 댓글 로드
        async function loadComments() {
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i></div>';
            
            try {
                const token = localStorage.getItem('memberToken');
                const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
                
                const response = await fetch(`${API_BASE}/posts/member/${profileId}/comments`, { headers });
                const result = await response.json();
                
                if (result.success && result.data.comments.length > 0) {
                    commentsList.innerHTML = result.data.comments.map(comment => `
                        <div class="comment-item">
                            <div class="comment-post-link">
                                <a href="board-view.html?id=${comment.post?._id}">${comment.post?.title || '삭제된 게시글'}</a>에 남긴 댓글
                            </div>
                            <div class="comment-content">${escapeHtml(comment.content)}</div>
                            <div class="comment-date">${formatDate(new Date(comment.createdAt))}</div>
                        </div>
                    `).join('');
                } else {
                    commentsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comment"></i>
                            <p>작성한 댓글이 없습니다</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('댓글 로드 오류:', error);
                commentsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>댓글을 불러올 수 없습니다</p>
                    </div>
                `;
            }
        }
        
        // 포스트 작성
        function updatePostBtn() {
            const input = document.getElementById('postInput');
            const btn = document.getElementById('postBtn');
            const count = document.getElementById('charCount');
            
            count.textContent = input.value.length;
            btn.disabled = input.value.trim().length === 0;
        }
        
        async function submitPost() {
            const input = document.getElementById('postInput');
            const content = input.value.trim();
            
            if (!content) return;
            
            try {
                const token = localStorage.getItem('memberToken');
                const response = await fetch(`${API_BASE}/feed`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ content })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    input.value = '';
                    updatePostBtn();
                    loadFeed();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('포스트 작성 오류:', error);
                alert('포스트 작성에 실패했습니다');
            }
        }
        
        // 팔로우 토글
        async function toggleFollow() {
            const token = localStorage.getItem('memberToken');
            if (!token) {
                alert('로그인이 필요합니다');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/members/${profileId}/follow`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    isFollowing = result.data.isFollowing;
                    const btn = document.getElementById('followBtn');
                    btn.className = 'follow-btn ' + (isFollowing ? 'following' : 'not-following');
                    btn.textContent = isFollowing ? '팔로잉' : '팔로우';
                    
                    document.getElementById('followerCount').textContent = result.data.followerCount;
                }
            } catch (error) {
                console.error('팔로우 오류:', error);
            }
        }
        
        // 피드 좋아요
        // 피드 삭제
        let deletingFeedId = null;
        
        function deleteFeed(feedId) {
            deletingFeedId = feedId;
            document.getElementById('deleteModal').classList.remove('hidden');
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            deletingFeedId = null;
        }
        
        async function confirmDeleteFeed() {
            if (!deletingFeedId) return;
            
            try {
                const token = localStorage.getItem('memberToken');
                const response = await fetch(`${API_BASE}/feed/${deletingFeedId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // 애니메이션으로 삭제
                    const feedEl = document.getElementById('feed-' + deletingFeedId);
                    if (feedEl) {
                        feedEl.style.opacity = '0';
                        feedEl.style.transform = 'translateX(-20px)';
                        setTimeout(() => feedEl.remove(), 200);
                    }
                    closeDeleteModal();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('피드 삭제 오류:', error);
                alert('피드 삭제에 실패했습니다');
            }
        }
        
        // 피드 좋아요
        async function toggleFeedLike(feedId, el) {
            const token = localStorage.getItem('memberToken');
            if (!token) {
                alert('로그인이 필요합니다');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/feed/${feedId}/like`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    el.classList.toggle('liked', result.data.isLiked);
                    el.querySelector('span').textContent = result.data.likeCount;
                }
            } catch (error) {
                console.error('좋아요 오류:', error);
            }
        }
        
        // 마이페이지 열기
        function openMyPage() {
            // nav.js의 마이페이지 모달 열기
            if (typeof window.openMyPageModal === 'function') {
                window.openMyPageModal();
            }
        }
        
        // 등급 정보
        function getGradeInfo(memberType) {
            switch(memberType) {
                case 'party_member':
                    return { text: '당원', class: 'grade-party' };
                case 'innovation_member':
                    return { text: '혁신당원', class: 'grade-innovation' };
                case 'position_member':
                    return { text: '직분당원', class: 'grade-position' };
                default:
                    return { text: '일반', class: 'grade-general' };
            }
        }
        
        // 날짜 포맷
        function formatDate(date) {
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return '방금 전';
            if (diff < 3600000) return Math.floor(diff / 60000) + '분 전';
            if (diff < 86400000) return Math.floor(diff / 3600000) + '시간 전';
            if (diff < 604800000) return Math.floor(diff / 86400000) + '일 전';
            
            return `${date.getMonth() + 1}월 ${date.getDate()}일`;
        }
        
        // HTML 이스케이프
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
    <!-- 공통 푸터 -->
    <div id="footer-container"></div>
    <script src="/footer.js"></script>
</body>
</html>
